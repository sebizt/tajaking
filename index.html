<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- ✅ 공통 Firebase 초기화 -->
    <script type="module" src="./firebase_init.js"></script>

    <title>오성 타자왕</title>
    <meta name="description" content="오성타자왕" />
    <link rel="icon" href="school-logo.png" />
    <link rel="stylesheet" href="./typing_site_v_3_app.css" />
</head>

<body>
    <main class="container">
        <!-- 상단 브랜드 카드 -->
        <section class="card card--win" style="margin-top:16px">
            <div class="winbar">
                <span class="winbar__dot" style="background:#ef4444"></span>
                <span class="winbar__dot" style="background:#f59e0b"></span>
                <span class="winbar__dot" style="background:#22c55e"></span>
                <span class="winbar__title">오성 타자왕 — 메인</span>
            </div>
            <div class="row" style="align-items:center; gap:16px; padding:18px">
                <img src="school-logo.png" alt="Ohseong High School" class="brand-inline"
                    style="width:64px; height:64px; border-radius:10px" />
                <div style="flex:1">
                    <h1 class="brand-inline" style="margin:0">천안오성고 타자왕은 누구 ?</h1>
                    <p class="muted" style="margin:.25rem 0 0">
                        학번/이름으로 입장 → 연습 완료 시 자동 기록 저장 → 리더보드 반영
                    </p>
                </div>

                <!-- ✅ 로그인 상태에 따라 버튼 동적 표시 -->
<div class="actions">
  <a id="authBtn" class="btn btn--primary">입장하기</a>
  <a id="startBtn" href="typing_site_v_3_practice.html" class="btn btn--primary">연습 시작</a>
</div>

                <!-- 로그인 상태는 버튼 아래쪽에 -->
                <div id="userStatus" class="muted"
                    style="font-size:.9rem; text-align:right; margin-top:6px; min-height:1.5em"></div>
        </section>

        <!-- 리더보드 카드 -->
        <section class="card card--win" id="leaderboard" style="margin-top:16px">
            <div class="winbar">
                <span class="winbar__dot" style="background:#ef4444"></span>
                <span class="winbar__dot" style="background:#f59e0b"></span>
                <span class="winbar__dot" style="background:#22c55e"></span>
                <span class="winbar__title">리더보드 Top 10</span>
            </div>
            <div style="padding:14px">
                <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px">
                    <div class="badge">개인 모드</div>
                </div>
                <div class="table-wrap">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>순위</th>
                                <th>학번</th>
                                <th>이름</th>
                                <th>WPM</th>
                                <th>정확도</th>
                                <th>시간</th>
                            </tr>
                        </thead>
                        <tbody id="lbBody">
                            <tr>
                                <td colspan="6" style="text-align:center; padding:12px">불러오는 중…</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- 사용 방법 -->
        <section class="card" style="margin-top:16px; padding:16px">
            <h3 style="margin-top:0">사용 방법</h3>
            <ol style="margin:0 0 0 18px">
                <li>상단 <b>입장하기</b>에서 학번/이름 입력</li>
                <li><b>연습 시작</b> 버튼으로 타자 연습</li>
                <li>완주/종료 시 기록 자동 저장, 본 페이지에서 순위 확인</li>
            </ol>
        </section>

        <p class="muted" style="text-align:center; margin:18px 0 32px">
            © <span id="yy"></span> Cheonan Ohseong High School • Typing Practice
        </p>
    </main>

    <script>
        // 연도 표시
        document.getElementById('yy').textContent = new Date().getFullYear();

        (function () {
            const USER_KEY = 'typing_user_v9';
            const startBtn = document.getElementById('startBtn');

            function getUser() {
                try { return JSON.parse(localStorage.getItem(USER_KEY) || 'null'); }
                catch { return null; }
            }

            startBtn.addEventListener('click', (e) => {
                const u = getUser();
                if (!u || !u.id || !u.name) {
                    e.preventDefault();
                    alert('먼저 로그인해주세요!');
                    location.href = 'typing_site_v_3_login.html';
                }
            });
        })();

        // ✅ 로그인/로그아웃 토글 기능
        (function () {
            const USER_KEY = 'typing_user_v9';
            const authBtn = document.getElementById('authBtn');
            const userStatus = document.getElementById('userStatus');

            function getUser() {
                try { return JSON.parse(localStorage.getItem(USER_KEY) || 'null'); }
                catch (e) { return null; }
            }

            function render() {
                const u = getUser();
                if (u && u.id && u.name) {
                    authBtn.textContent = '로그아웃';
                    authBtn.classList.remove('btn--primary');
                    authBtn.classList.add('btn--danger');
                    userStatus.innerHTML = `현재 로그인: <strong>${u.id}</strong> · <strong>${u.name}</strong>`;
                } else {
                    authBtn.textContent = '입장하기';
                    authBtn.classList.add('btn--primary');
                    authBtn.classList.remove('btn--danger');
                    userStatus.textContent = '현재 로그인된 사용자가 없습니다.';
                }
            }

            authBtn.addEventListener('click', () => {
                const u = getUser();
                if (u && u.id && u.name) {
                    // 로그아웃
                    localStorage.removeItem(USER_KEY);
                    render();
                } else {
                    // 로그인 페이지로 이동
                    location.href = 'typing_site_v_3_login.html';
                }
            });

            render();
        })();

        // 리더보드
        function renderRows(list) {
            const body = document.getElementById('lbBody');
            body.innerHTML = '';
            if (!list || !list.length) {
                body.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:12px">기록이 없습니다.</td></tr>';
                return;
            }
            list.forEach((r, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${i + 1}</td><td>${r.sid || ''}</td><td>${r.sname || ''}</td><td>${r.wpm ?? '-'}</td><td>${r.accuracy ?? '-'}%</td><td>${Math.round(r.time_sec ?? 0)}s</td>`;
                body.appendChild(tr);
            });
        }

        // TypingAPI 준비 확인
        async function waitForTypingAPI(timeoutMs = 10000, intervalMs = 100) {
            const start = Date.now();
            if (window.TypingReady) {
                try { await window.TypingReady; } catch (_) { }
            }
            if (window.TypingAPI && typeof window.TypingAPI.loadLeaderboard === 'function') return true;
            return await new Promise(resolve => {
                const t = setInterval(() => {
                    const ready = (window.TypingAPI && typeof window.TypingAPI.loadLeaderboard === 'function');
                    if (ready || (Date.now() - start) > timeoutMs) {
                        clearInterval(t);
                        resolve(ready);
                    }
                }, intervalMs);
            });
        }

        (async () => {
            const ready = await waitForTypingAPI();
            if (!ready) {
                renderRows([]);
                return;
            }
            try {
                const rows = await window.TypingAPI.loadLeaderboard({ mode: 'solo', top: 10 });
                renderRows(rows);
            } catch {
                renderRows([]);
            }
        })();
    </script>
</body>

</html>
