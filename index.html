<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- âœ… ê³µí†µ Firebase ì´ˆê¸°í™” -->
    <script type="module" src="./firebase_init.js"></script>

    <title>ì˜¤ì„± íƒ€ìì™•</title>
    <meta name="description" content="ì˜¤ì„±íƒ€ìì™•" />
    <link rel="icon" href="school-logo.png" />
    <link rel="stylesheet" href="./typing_site_v_3_app.css" />
</head>

<body>
    <main class="container">
        <!-- ìƒë‹¨ ë¸Œëœë“œ ì¹´ë“œ -->
        <section class="card card--win" style="margin-top:16px">
            <div class="winbar">
                <span class="winbar__dot" style="background:#ef4444"></span>
                <span class="winbar__dot" style="background:#f59e0b"></span>
                <span class="winbar__dot" style="background:#22c55e"></span>
                <span class="winbar__title">ì˜¤ì„± íƒ€ìì™• â€” ë©”ì¸</span>
            </div>
            <div class="row" style="align-items:center; gap:16px; padding:18px">
                <img src="school-logo.png" alt="Ohseong High School" class="brand-inline"
                    style="width:64px; height:64px; border-radius:10px" id="logoReload" />
                <div style="flex:1">
                    <h1 class="brand-inline" style="margin:0">ì²œì•ˆì˜¤ì„±ê³  íƒ€ìì™•ì€ ëˆ„êµ¬ ?</h1>
                    <p class="muted" style="margin:.25rem 0 0">
                        í•™ë²ˆ/ì´ë¦„ìœ¼ë¡œ ì…ì¥ â†’ ì—°ìŠµ ì™„ë£Œ ì‹œ ìë™ ê¸°ë¡ ì €ì¥ â†’ ë¦¬ë”ë³´ë“œ ë°˜ì˜
                    </p>
                </div>

                <!-- âœ… ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ ë™ì  í‘œì‹œ -->
                <div class="actions">
                    <a id="authBtn" class="btn btn--primary">ì…ì¥í•˜ê¸°</a>
                    <a id="startBtn" href="typing_site_v_3_practice.html" class="btn btn--primary">ì—°ìŠµ ì‹œì‘</a>
                </div>

                <!-- ë¡œê·¸ì¸ ìƒíƒœëŠ” ë²„íŠ¼ ì•„ë˜ìª½ì— -->
                <div id="userStatus" class="muted"
                    style="font-size:.9rem; text-align:right; margin-top:6px; min-height:1.5em"></div>
        </section>

        <!-- ë¦¬ë”ë³´ë“œ ì¹´ë“œ -->
        <section class="card card--win" id="leaderboard" style="margin-top:16px">
            <div class="winbar">
                <span class="winbar__dot" style="background:#ef4444"></span>
                <span class="winbar__dot" style="background:#f59e0b"></span>
                <span class="winbar__dot" style="background:#22c55e"></span>
                <span class="winbar__title">ë¦¬ë”ë³´ë“œ Top 10</span>
            </div>
            <div style="padding:14px">
                <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px">
                    <!-- í˜„ì¬ ì„ íƒëœ ëª¨ë“œ í‘œì‹œ -->
                    <div id="lbModeLabel" class="badge">ê°œì¸ ëª¨ë“œ</div>

                    <!-- ëª¨ë“œ íƒ­ ë²„íŠ¼ -->
                    <div class="lb-tabs">
                        <button class="btn btn--sm lb-tab lb-tab--active" data-mode="solo">ê°œì¸</button>
                        <button class="btn btn--sm lb-tab" data-mode="together">ì‚¬ì œ</button>
                    </div>
                </div>

                <div class="table-wrap">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ìˆœìœ„</th>
                                <th>í•™ë²ˆ</th>
                                <th>ì´ë¦„</th>
                                <th>WPM</th>
                                <th>ì •í™•ë„</th>
                                <th>ì‹œê°„</th>
                            </tr>
                        </thead>
                        <tbody id="lbBody">
                            <tr>
                                <td colspan="6" style="text-align:center; padding:12px">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- ì‚¬ìš© ë°©ë²• -->
        <section class="card" style="margin-top:16px; padding:16px">
            <h3 style="margin-top:0">ì‚¬ìš© ë°©ë²•</h3>
            <ol style="margin:0 0 0 18px">
                <li>ìƒë‹¨ <b>ì…ì¥í•˜ê¸°</b>ì—ì„œ í•™ë²ˆ/ì´ë¦„ ì…ë ¥</li>
                <li><b>ì—°ìŠµ ì‹œì‘</b> ë²„íŠ¼ìœ¼ë¡œ íƒ€ì ì—°ìŠµ</li>
                <li>ì™„ì£¼/ì¢…ë£Œ ì‹œ ê¸°ë¡ ìë™ ì €ì¥, ë³¸ í˜ì´ì§€ì—ì„œ ìˆœìœ„ í™•ì¸</li>
            </ol>
        </section>

        <p class="muted" style="text-align:center; margin:18px 0 32px">
            Â© <span id="yy"></span> Cheonan Ohseong High School â€¢ Typing Practice
        </p>
    </main>

    <script>
        // ì—°ë„ í‘œì‹œ
document.getElementById('logoReload')?.addEventListener('click', () => {
localStorage.clear();
location.reload();

});


        document.getElementById('yy').textContent = new Date().getFullYear();

        (function () {
            const USER_KEY = 'typing_user_v9';
            const startBtn = document.getElementById('startBtn');

            function getUser() {
                try { return JSON.parse(localStorage.getItem(USER_KEY) || 'null'); }
                catch { return null; }
            }

            startBtn.addEventListener('click', (e) => {
                const u = getUser();
                if (!u || !u.id || !u.name) {
                    e.preventDefault();
                    alert('ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”!');
                    location.href = 'typing_site_v_3_login.html';
                }

                e.preventDefault(); // a íƒœê·¸ ê¸°ë³¸ ì´ë™ ë§‰ê³  ìš°ë¦¬ê°€ ì§ì ‘ ë³´ëƒ„

    const mode = (u.mode || 'solo').toLowerCase();   // 'solo' | 'together'
    const teacher = (u.teacher || '').trim();

    const params = new URLSearchParams();
    params.set('mode', mode);
    if (teacher && mode === 'together') {
      params.set('teacher', teacher);
    }

    // í•„ìš”í•˜ë©´ sid/snameë„ ê°™ì´ ë³´ë‚¼ ìˆ˜ë„ ìˆìŒ
    // params.set('sid', u.id);
    // params.set('sname', u.name);

    const url = `typing_site_v_3_practice.html?${params.toString()}`;
    location.href = url;
  
            });
        })();

        // âœ… ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ í† ê¸€ ê¸°ëŠ¥
        (function () {
            const USER_KEY = 'typing_user_v9';
            const authBtn = document.getElementById('authBtn');
            const userStatus = document.getElementById('userStatus');

            function getUser() {
                try { return JSON.parse(localStorage.getItem(USER_KEY) || 'null'); }
                catch (e) { return null; }
            }

            function render() {
                const u = getUser();
                if (u && u.id && u.name) {
                    authBtn.textContent = 'ë¡œê·¸ì•„ì›ƒ';
                    authBtn.classList.remove('btn--primary');
                    authBtn.classList.add('btn--danger');
                    userStatus.innerHTML = `í˜„ì¬ ë¡œê·¸ì¸: <strong>${u.id}</strong> Â· <strong>${u.name}</strong>`;
                } else {
                    authBtn.textContent = 'ì…ì¥í•˜ê¸°';
                    authBtn.classList.add('btn--primary');
                    authBtn.classList.remove('btn--danger');
                    userStatus.textContent = 'í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.';
                }
            }

            authBtn.addEventListener('click', () => {
                const u = getUser();
                if (u && u.id && u.name) {
                    // ë¡œê·¸ì•„ì›ƒ
                    localStorage.removeItem(USER_KEY);
                    render();
                } else {
                    // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                    location.href = 'typing_site_v_3_login.html';
                }
            });

            render();
        })();

        // ë¦¬ë”ë³´ë“œ
        function renderRows(list) {
            const body = document.getElementById('lbBody');
            body.innerHTML = '';
            if (!list || !list.length) {
                body.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:12px">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            // ì •ë ¬: WPM ë†’ì€ ìˆœ â†’ ì‹œê°„ì´ ì§§ì€ ìˆœ
            const sorted = [...list].sort((a, b) => {
                const aw = a.wpm || 0, bw = b.wpm || 0;
                if (bw !== aw) return bw - aw;
                const at = a.time_sec || 999999, bt = b.time_sec || 999999;
                return at - bt;
            });

            // í˜„ì¬ ë¡œê·¸ì¸ ìœ ì € (ë‚´ ê¸°ë¡ ê°•ì¡°ìš©)
            let currentUser = null;
            try {
                currentUser = JSON.parse(localStorage.getItem('typing_user_v9') || 'null');
            } catch (e) {
                currentUser = null;
            }

            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];

            sorted.forEach((r, i) => {
                const tr = document.createElement('tr');
                const rank = i + 1;

                tr.classList.add('lb-row');
                if (rank === 1) tr.classList.add('lb-row--top1');
                else if (rank === 2) tr.classList.add('lb-row--top2');
                else if (rank === 3) tr.classList.add('lb-row--top3');

                if (currentUser && r.sid === currentUser.id) {
                    tr.classList.add('lb-row--me');
                }

                const label = medals[rank - 1] || `#${rank}`;
                const timeSec = Math.round(r.time_sec ?? 0);
                const timeStr = isFinite(timeSec) ? `${timeSec}s` : '-';

                tr.innerHTML = `
            <td class="lb-rank">${label}</td>
            <td>${r.sid || ''}</td>
            <td>${r.sname || ''}</td>
            <td><strong>${r.wpm ?? '-'}</strong></td>
            <td>${r.accuracy ?? '-'}%</td>
            <td>${timeStr}</td>
        `;
                body.appendChild(tr);
            });
        }


        // TypingAPI ì¤€ë¹„ í™•ì¸
        async function waitForTypingAPI(timeoutMs = 10000, intervalMs = 100) {
            const start = Date.now();
            if (window.TypingReady) {
                try { await window.TypingReady; } catch (_) { }
            }
            if (window.TypingAPI && typeof window.TypingAPI.loadLeaderboard === 'function') return true;
            return await new Promise(resolve => {
                const t = setInterval(() => {
                    const ready = (window.TypingAPI && typeof window.TypingAPI.loadLeaderboard === 'function');
                    if (ready || (Date.now() - start) > timeoutMs) {
                        clearInterval(t);
                        resolve(ready);
                    }
                }, intervalMs);
            });
        }
        let currentLbMode = 'solo';

        async function loadLeaderboardWithMode(mode) {
            currentLbMode = mode;
            const labelEl = document.getElementById('lbModeLabel');

            if (labelEl) {
                labelEl.textContent = mode === 'solo' ? 'ê°œì¸ ëª¨ë“œ' : 'ì‚¬ì œ ëª¨ë“œ';
            }

            const ready = await waitForTypingAPI();
            if (!ready) {
                renderRows([]);
                return;
            }

            try {
                const rows = await window.TypingAPI.loadLeaderboard({ mode, top: 10 });
                renderRows(rows);
            } catch (e) {
                console.error('loadLeaderboard ì‹¤íŒ¨', e);
                renderRows([]);
            }
        }

        // ì²˜ìŒì—ëŠ” ê°œì¸ ëª¨ë“œë¡œ ë¡œë”©
        loadLeaderboardWithMode('solo');

        // íƒ­ ë²„íŠ¼ ì´ë²¤íŠ¸
        (function () {
            const tabs = document.querySelectorAll('.lb-tab');
            tabs.forEach(btn => {
                btn.addEventListener('click', () => {
                    const mode = btn.getAttribute('data-mode') || 'solo';

                    // active í´ë˜ìŠ¤ í† ê¸€
                    tabs.forEach(b => b.classList.remove('lb-tab--active'));
                    btn.classList.add('lb-tab--active');

                    loadLeaderboardWithMode(mode);
                });
            });
        })();


    </script>
</body>

</html>
